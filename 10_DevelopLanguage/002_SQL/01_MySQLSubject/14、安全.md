###### 1. 如何防止 SQL 注入？
SQL注入是攻击者通过将恶意SQL代码插入输入参数，欺骗服务器执行非法操作的行为。以下是核心防护方案：
**1. 使用预编译语句（PreparedStatement）**
这是最有效、最根本的防御手段。
- **原理**：将SQL语句的**结构（模板）与**数据（参数）**​ 分开发送。数据库服务器会先对SQL模板进行编译和优化，此时指令结构已固定。随后传入的参数无论内容如何，都会被当作纯数据处理，无法改变原有指令意图。
- **Java代码示例**：
```java
String sql = "SELECT * FROM users WHERE username = ? AND password = ?";
PreparedStatement pstmt = connection.prepareStatement(sql);
pstmt.setString(1, username); // 第一个问号被替换为username变量值
pstmt.setString(2, password);
ResultSet rs = pstmt.executeQuery();
```
- **源码视角**：在JDBC驱动实现中，`PreparedStatement`的实现类（如`com.mysql.cj.jdbc.PreparedStatement`）会对参数进行转义，确保其作为数据而非指令的一部分。
**2. 使用ORM框架（如MyBatis, Hibernate）**
现代ORM框架默认使用预编译，提供了另一层抽象和安全保障。
- **MyBatis**：**必须使用 `#{}`语法**，它会将参数转换为预编译语句的参数。**严禁使用 `${}`**，因为它会直接进行字符串拼接，存在注入风险。
```xml
<!-- 安全 -->
   <select id="getUser" resultType="User">
       SELECT * FROM users WHERE username = #{username}
   </select>
  <!-- 危险！ -->
   <select id="getUserUnsafe" resultType="User">
      SELECT * FROM users WHERE username = '${username}'
   </select>
```
- **Hibernate**：使用`createQuery`或Criteria API，它们也基于预编译原理。
**3. 输入验证与过滤**
这属于**纵深防御措施**，而非唯一依赖。对用户输入进行严格检查（如类型、长度、格式），拒绝明显非法请求。
```java
// 示例：使用正则表达式校验用户名格式
if (!username.matches("[a-zA-Z0-9_]{1,20}")) {
    throw new IllegalArgumentException("Invalid username format");
}
```
**4. 其他安全配置**
- **最小权限原则**：为应用数据库用户分配**仅能满足其功能所需的最小权限**。例如，查询账号只授予`SELECT`权限，绝不授予`DROP`、`ALTER`等危险权限。
- **避免泄露信息**：定制统一的错误页面，防止将详细的数据库错误信息直接暴露给用户。
###### 2. MySQL 的用户权限管理是怎样的？
MySQL的权限管理系统是一个**多层次的、精细化的访问控制体系**，其核心思想是“**最小权限原则**”。
**1. 权限体系的核心表**
权限信息存储在`mysql`系统数据库中，主要包括以下几张表，形成一个层级结构：
- `mysql.user`：存储**用户账户信息**和**全局权限**。用户是否能连接数据库，以及是否拥有对整个MySQL实例（所有数据库）的权限，都在此决定。
- `mysql.db`：存储**数据库级权限**。规定用户对某个特定数据库（如`mydb.*`）的操作权限。
- `mysql.tables_priv`：存储**表级权限**。控制用户对特定数据库的特定表的权限。
- `mysql.columns_priv`：存储**列级权限**。这是最细的粒度，控制用户对特定表的特定列的权限（如允许某用户查看`users`表的`name`列，但不能看`salary`列）。
**2. 权限验证流程**
当用户执行一个操作时，MySQL会**从粗到细**进行权限检查：
1. **身份认证**：检查`user`表，验证用户名、密码和主机名是否允许连接。
2. 检查**全局权限**：如果`user`表中某权限为`'Y'`（例如`Select_priv='Y'`），则用户对所有数据库都有该权限。
3. 检查**数据库权限**：如果没有全局权限，则检查`db`表，看用户是否对当前操作的数据库有相应权限。
4. 检查**表权限**：若无数据库权限，则检查`tables_priv`表。
5. 检查**列权限**：最后，如果需要，会检查`columns_priv`表。
**原则是：如果任一层级授权通过，则操作被允许。更具体层级的权限设置优先。**
**3. 角色（Role）**
MySQL 8.0 引入了角色功能，可以将一组权限打包成一个角色，然后直接将角色授予用户，极大简化了权限管理。
```sql
CREATE ROLE 'read_only';
GRANT SELECT ON *.* TO 'read_only';
GRANT 'read_only' TO 'app_user'@'%';
```
###### 3. 如何创建和管理 MySQL 用户？
**1. 创建用户**
使用 `CREATE USER`语句。
```sql
CREATE USER 'new_user'@'localhost' IDENTIFIED BY 'strong_password';
```
- `'new_user'@'localhost'`：用户名和允许连接的主机。`localhost`表示只能从本机连接，`%`表示可以从任意主机连接，但生产环境应限制为应用服务器IP以提高安全性。
- `IDENTIFIED BY ...`：设置密码。MySQL 8.0默认使用更安全的`caching_sha2_password`插件。
**2. 查看与管理用户**
```sql
-- 查看所有用户
SELECT user, host FROM mysql.user;
-- 修改用户密码
ALTER USER 'new_user'@'localhost' IDENTIFIED BY 'new_strong_password';
-- 设置密码过期策略（例如90天）
ALTER USER 'new_user'@'localhost' PASSWORD EXPIRE INTERVAL 90 DAY [10](@ref);
-- 删除用户
DROP USER 'new_user'@'localhost' [10](@ref);
```
###### 4. 如何给用户授权和回收权限？
**1. 授权（GRANT）**
使用 `GRANT`语句将特定权限授予用户或角色。
```sql
-- 授予对特定数据库的所有表的 SELECT 和 INSERT 权限
GRANT SELECT, INSERT ON my_database.* TO 'new_user'@'localhost';
-- 授予所有权限（相当于管理员，慎用）
GRANT ALL PRIVILEGES ON *.* TO 'admin_user'@'%' WITH GRANT OPTION;
-- 将角色授予用户
GRANT 'read_only' TO 'new_user'@'localhost';
```
**关键**：授权后，通常需要执行 `FLUSH PRIVILEGES;`命令使新权限立即生效（尤其是在直接修改权限表后）。但使用标准的`GRANT`/`REVOKE`语句后，通常不需要手动刷新。
**2. 回收权限（REVOKE）**
使用 `REVOKE`语句撤销权限。
```sql
-- 回收 INSERT 权限
REVOKE INSERT ON my_database.* FROM 'new_user'@'localhost';
-- 回收所有权限
REVOKE ALL PRIVILEGES ON *.* FROM 'admin_user'@'%';
```
**3. 查看权限**
```sql
-- 查看当前用户的权限
SHOW GRANTS;
-- 查看特定用户的权限
SHOW GRANTS FOR 'new_user'@'localhost' [10](@ref);
```
###### 5. MySQL 的数据加密方式有哪些？
MySQL提供了多种加密方式来保护数据，涵盖传输、存储和静态数据。
**1. 传输层加密（TLS/SSL）**
- **目标**：加密客户端与MySQL服务器之间的网络通信，防止数据在传输过程中被窃听或篡改。
- **配置**：需要在服务器端配置SSL证书和密钥，并在客户端连接字符串中指定使用SSL。
**2. 静态数据加密**
- **InnoDB表空间加密**：MySQL 5.7及以上版本支持对InnoDB表空间（包括系统表空间、独立表空间、通用表空间）进行加密。它使用**两层密钥机制**：主密钥（Keyring）用于解密表空间密钥，表空间密钥用于加密和解密实际数据。即使数据文件被窃取，在没有密钥的情况下也无法读取。
```sql
-- 为表启用加密
ALTER TABLE sensitive_data ENCRYPTION = 'Y';
```
- **二进制日志加密**：MySQL 8.0+支持对二进制日志文件进行加密，防止包含敏感数据的SQL语句在日志文件中以明文形式存在。
**3. 应用层加密**
- **描述**：在数据存入数据库**之前**，由应用程序使用加密算法（如AES）对敏感字段（如身份证号、手机号）进行加密，数据库仅存储密文。查询时，需先加密查询条件，或在应用层解密结果集。
- **优点**：安全性最高，即使数据库管理员也无法直接看到明文数据。
- **缺点**：无法利用数据库索引对加密后的数据进行高效检索，且加解密操作会消耗应用服务器CPU资源。