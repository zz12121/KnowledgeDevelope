###### 1. 什么是负载均衡？
负载均衡是一种将网络流量或计算任务智能地分发到多个后端服务器（或服务实例）的技术，旨在优化资源使用、最大化吞吐量、最小化响应时间，并避免单点过载，从而提高系统的整体可用性、扩展性和容错能力。其核心是一个调度器（负载均衡器），它根据预设的算法和实时健康状态，在多个后端资源之间分配请求。从架构层次看，负载均衡可以发生在网络层（L4，如LVS）、应用层（L7，如Nginx）或通过客户端（如Ribbon）实现。在微服务架构中，负载均衡是服务间通信的基石，通常与服务发现（如Eureka、Nacos）紧密结合。
###### 2. 负载均衡的分类有哪些？
- **按实现位置分类**：
    - **硬件负载均衡**：使用专用设备，如F5 BIG-IP、A10。性能极高，功能丰富，但成本昂贵。
    - **软件负载均衡**：在通用服务器上运行软件实现，如Nginx、LVS、HAProxy。灵活、成本低，是互联网公司的主流选择。
- **按网络模型（OSI层次）分类**：
    - **四层负载均衡**：基于网络层（IP）和传输层（TCP/UDP）信息，如源/目标IP地址和端口号进行转发。LVS是典型代表，效率高，对应用透明。
    - **七层负载均衡**：基于应用层协议（如HTTP、HTTPS、gRPC）的内容进行转发。可以解析URL、Header、Cookie等信息，实现更精细的路由（如根据API路径转发到不同服务）。Nginx、HAProxy是典型代表。
- **按实现方式分类**：
    - **服务端负载均衡**：负载均衡器独立部署在客户端与服务端之间，所有流量都经过它。
    - **客户端负载均衡**：负载均衡逻辑集成在服务消费者内部，客户端从服务注册中心获取服务列表后，自行选择目标实例。如Spring Cloud Ribbon。
###### 3. Nginx 的负载均衡策略有哪些？
Nginx 在 `ngx_http_upstream_module`模块中实现了多种负载均衡算法，通过 `upstream`指令块配置：
1. **轮询**：默认策略。将请求按时间顺序逐一分配到不同的后端服务器。
2. **加权轮询**：在轮询基础上，通过 `weight`参数指定权重，权重越高的服务器被分配到的请求比例越大。其内部实现维护了一个基于权重的平滑分布算法，并非简单循环。
3. **IP哈希**：通过 `ip_hash`指令启用。根据客户端IP地址计算哈希值，将同一IP的请求固定到同一台后端服务器，用于会话保持。
4. **最少连接**：通过 `least_conn`指令启用。将请求优先分配给当前活跃连接数最少的后端服务器。
5. **基于响应的负载均衡**：商业版Nginx Plus支持，如 `least_time`，优先分配给平均响应时间最短或当前连接数最少的服务器。
    **源码角度**：在Nginx源码中，`ngx_http_upstream_init_round_robin`函数初始化轮询和加权轮询的服务器列表。对于加权轮询，其核心算法在 `ngx_http_upstream_get_peer`函数中，通过动态计算 `effective_weight`和 `current_weight`来实现平滑的加权分配，避免短时间内将所有高权重请求集中发出。
###### 4. LVS 的工作模式有哪些？
LVS（Linux Virtual Server）是内核级别的四层负载均衡解决方案，由章文嵩博士开发。其工作模式决定了数据包如何从负载均衡器转发到真实服务器：
1. **NAT模式**：
    - **原理**：负载均衡器修改数据包的目标IP地址（和端口）为选中的真实服务器IP，返回时再修改源地址为VIP。双向流量都经过负载均衡器。
    - **优点**：真实服务器可使用任何操作系统，只需配置网关为负载均衡器IP。
    - **缺点**：负载均衡器容易成为瓶颈，因为要处理出入两个方向的流量。
2. **TUN模式**：
    - **原理**：负载均衡器将请求数据包封装在一个新的IP包中（IP隧道），目标地址为真实服务器。真实服务器解封装后直接响应客户端（不经过负载均衡器）。
    - **优点**：响应流量不经过负载均衡器，性能高。
    - **缺点**：真实服务器必须支持IP隧道协议，且需要配置自己的回环地址为VIP。
3. **DR模式**：
    - **原理**：负载均衡器只修改数据帧的MAC地址，将其转发给选中的真实服务器。真实服务器必须配置和负载均衡器相同的VIP，但通过ARP抑制避免响应ARP请求。服务器处理请求后直接响应客户端。
    - **优点**：性能最高，因为只有请求的入站流量经过负载均衡器，响应直接返回。
    - **缺点**：要求负载均衡器与真实服务器在同一个物理网络（二层可达），且真实服务器需要做VIP和ARP抑制配置。
        **源码角度**：LVS的代码位于Linux内核的 `net/netfilter/ipvs/`目录。不同模式对应不同的转发器（`ip_vs_conn`结构）。例如，DR模式的核心转发函数 `ip_vs_dr_xmit`在 `ip_vs_dr.c`中，它直接调用 `dev_queue_xmit`将数据帧从出口网卡发出。
###### 5. 什么是反向代理？
反向代理是一种代理服务器的部署模式，它代表一个或多个后端服务器接收客户端的请求，然后将请求转发给内部服务器，并将从内部服务器得到的结果返回给客户端。对客户端而言，它就像是原始的资源服务器。其核心功能包括：
- **负载均衡**：将客户端请求分发到多个后端服务器。
- **安全与匿名**：隐藏后端服务器的真实IP地址和拓扑结构，提供统一的入口。
- **缓存加速**：缓存静态资源甚至动态内容，直接返回给客户端，减轻后端压力。
- **SSL终结**：在反向代理处进行HTTPS加解密，将明文的HTTP请求转发给后端，简化后端服务器的SSL配置。
- **压缩与优化**：对响应内容进行Gzip压缩等。
    Nginx和Apache HTTP Server常被用作反向代理服务器。
###### 6. 正向代理和反向代理的区别是什么？
区别的核心在于**代理的对象不同**和**部署位置不同**。

|特性|正向代理|反向代理|
|---|---|---|
|**代理对象**​|代理**客户端**，代表客户端向任意服务器发起请求。|代理**服务器**，代表服务器接收来自任意客户端的请求。|
|**部署位置**​|通常部署在客户端网络或客户端侧（如公司出口、VPN）。|部署在服务器端网络，作为服务的前置入口。|
|**客户端感知**​|客户端必须显式配置代理服务器的地址（如浏览器设置）。|客户端无感知，认为自己在直接访问目标服务器。|
|**主要用途**​|突破网络限制（如翻墙）、缓存加速、匿名访问、内容过滤。|负载均衡、安全防护、缓存加速、SSL终结、统一入口。|
|**例子**​|科学上网工具（Shadowsocks）、公司内网代理。|Nginx作为Web服务器的入口，CDN的边缘节点。
###### 7. 如何实现动态负载均衡？
动态负载均衡指负载均衡策略能根据后端服务器的实时状态（如CPU负载、内存使用率、响应时间、当前连接数）自动调整，而非静态配置。实现方式包括：
1. **健康检查**：负载均衡器定期主动（如发送HTTP请求、TCP SYN包）或被动（观察连接失败）检查后端服务器健康状态，自动将故障节点从服务列表中剔除。
2. **基于度量的权重调整**：集成监控系统（如Prometheus），收集后端服务器的各项性能指标，通过API动态调整Nginx等负载均衡器中服务器的 `weight`。例如，响应时间长的服务器降低其权重。
3. **服务发现集成**：在微服务架构中，负载均衡器（尤其是客户端负载均衡器如Ribbon）直接从服务注册中心（如Eureka、Consul、Nacos）动态获取服务实例列表和健康状态。当服务实例上线、下线或心跳异常时，注册中心通知订阅者，负载均衡器实时更新本地服务列表。
4. **自适应算法**：一些高级负载均衡器（如Nginx Plus、云服务商的LB）支持根据实时响应时间、错误率等指标自动调整流量分配。
    **实现示例**：使用Spring Cloud Gateway或Zuul作为网关，结合Ribbon和Eureka。Ribbon的 `ServerList`由 `DiscoveryEnabledNIWSServerList`从Eureka获取并动态更新。`IPing`接口的实现负责健康检查，`IRule`接口（如 `WeightedResponseTimeRule`）可以根据响应时间动态计算权重。
###### 8. 什么是会话保持（Session Sticky）？
会话保持，也称为粘性会话，是一种负载均衡策略，其目的是将来自同一客户端的一系列请求（一个会话）始终路由到同一台后端服务器上。这通常是为了解决有状态服务（如用户登录Session存储在服务器内存中）在负载均衡环境下的问题。
**实现方式**：
1. **基于源IP地址**：如Nginx的 `ip_hash`或LVS的持久化连接。简单但不可靠，因为同一局域网的用户可能共享同一出口IP。
2. **基于Cookie注入**：
    - **植入型Cookie**：负载均衡器在第一个响应中向客户端植入一个包含后端服务器标识的Cookie（如 `JSESSIONID=node01`），后续请求携带此Cookie，负载均衡器据此转发。
    - **重写型Cookie**：负载均衡器重写后端服务器设置的Cookie（如 `JSESSIONID`），在值中嵌入路由信息。
3. **基于特定Header或参数**：如根据HTTP请求中的用户ID进行哈希。
    **缺点**：
    - 破坏了负载均衡的纯粹性，可能导致负载不均。
    - 当目标服务器宕机时，该服务器上的会话会丢失（除非会话已做集群共享）。
        因此，在现代无状态架构中，更推荐将Session外部化到分布式缓存（如Redis）中，从而无需会话保持。