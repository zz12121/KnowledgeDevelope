```
Shopee是东南亚及中国台湾地区的电商平台 。 2015 年于新加坡成立并设立总部，随后拓展至马来西
亚、泰国、中国台湾地区、印度尼西亚、越南及菲律宾共七大市场。
Shopee拥有商品种类，包括电子消费品、家居、美容保健、母婴、服饰及健身器材等。
2022 年第二季度，Shopee保持业绩增长，其中总订单数 20 亿，同比增长41.6%。最新财报数据显示，
Shopee电商平台在今年第二季度的GMV为 190 亿美元，同比增长27.2%；总营收为 17 亿美元，同比增
长51.4%。
据data.ai， Shopee取得了 2022 年Q1全球购物类App总下载量第一、谷歌应用商店全球购物类App用户
使用总时长第一的佳绩。
```
### 100 W 用户同时在线的弹幕系统背景

```
为了更好的支持 shopee 东南亚直播业务，Shopee 平台产品设计为直播业务增加了弹幕。
第一期弹幕使用腾讯云支持，效果并不理想，
主要问题是：
经常卡顿、
弹幕偏少等问题。
最终促使Shopee团队，定制开发自己的弹幕系统。
其性能规划是： 单房间百万用户同时在线。
没有看错： 百万用户同时在线，而且是单房间 。
假如说每 3 秒促达用户一次，百万用户同时在线，单房间具体QPS将超过30w QPS
没有看错： 单房间具体QPS将超过30w QPS
```
### 问题分析

```
按照背景来分析，系统将主要面临以下问题：
1. 带宽压力
假如说每 3 秒促达用户一次，那么每次内容至少需要有 15 条才能做到视觉无卡顿。
15 条弹幕+http包头的大小将超过3k，那么每秒的数据大小约为8Gbps，
而运维同学通知我们所有服务的可用带宽仅为10Gbps。
2. 弱网导致的弹幕卡顿、丢失
该问题已在线上环境
3. 性能与可靠性
百万用户同时在线，按照上文的推算，具体QPS将超过30w QPS。
如何保证在双十一等重要活动中不出问题，至关重要。性能也是另外一个需要着重考虑的
点。
```
page: 1/12 of 尼恩 Java 硬核架构班：狠卷 3 高架构，卷透底层技术，走向技术自由！


### 架构设计和优化

```
那么，该如何做架构设计和优化呢？
主要的架构优化有：
业务解耦+服务拆分
引入本地缓存，优化高并发读
引入限流，优化高并发写
使用滑动窗口，实现无锁化读写
通过短轮训实现弹幕促达
传输优化、节约带宽
```
### 业务解耦+服务拆分

```
为了保证服务的稳定性我们对服务进行了拆分，进行业务解耦+服务拆分
```
##### 业务解耦+服务拆分的具体架构方案

```
将逻辑较为复杂、调用较少的发送弹幕业务与逻辑简单、调用量高的弹幕拉取服务拆分开来。
将复杂的逻辑收拢到发送弹幕的一端。
```
page: 2/12 of 尼恩 Java 硬核架构班：狠卷 3 高架构，卷透底层技术，走向技术自由！


```
服务拆分主要考虑因素是为了不让服务间相互影响，
对于这种系统服务，不同服务的QPS往往是不对等的，
例如像拉取弹幕的服务的请求频率和负载，通常会比发送弹幕服务高 1 到 2 个数量级，
```
page: 3/12 of 尼恩 Java 硬核架构班：狠卷 3 高架构，卷透底层技术，走向技术自由！


##### 解耦之后的优势：

```
实现一个小 3 高的目标： 高可用、高扩展、高协同
```
```
高可用
最大度地保证系统的可用性，
```
page: 4/12 of 尼恩 Java 硬核架构班：狠卷 3 高架构，卷透底层技术，走向技术自由！


```
在这种情况下，不能让拉弹幕服务把发弹幕服务搞垮，
反之亦然，不能让 发弹服务把拉弹幕服务 搞垮
```
```
高扩展
方便扩容和缩容
更加方便对各个服务做Scale-Up和Scale-Out。
```
```
高协同
方便协同开发
服务拆分也划清了业务边界，方便协同开发。
```
### 引入本地缓存优化高并发读

```
在拉取弹幕服务的一端：引入本地缓存
数据更新的策略是：
服务会定期发起RPC调用，从弹幕服务拉取数据，拉取到的弹幕缓存到内存中，
这样后续的请求过来时便能直接走走本地内存的读取，大大幅降低了调用时延。
这样做还有另外一个好处就是缩短调用链路，把数据放到离用户最近的地方
同时还能降低外部依赖的服务故障对业务的影响，
```
```
尼恩提示： 本地缓存非常重要，大家需要做到架构级、源码级精通
建议大家穿透 400Wqps本地缓存 caffeine的核心架构、核心源码，这个非常有价值，
具体，可以去学习第 25 章视频《穿透400Wqps caffeine源码》里边有caffeine的起底式、穿透式
介绍
```
### 引入限流，优化高并发写

```
在发送弹幕的一端: 限流（有损服务） ，
因为用户一定时间能看得过来弹幕总量是有限的，
所以可以对弹幕进行限流，有选择的丢弃多余的弹幕。
同时，采用柔性的处理方式，拉取用户头像、敏感词过滤等分支在调用失败的情况下，仍然能保证服务
的核心流程不受影响，即弹幕能够正常发送和接收，提供有损的服务。
```
page: 5/12 of 尼恩 Java 硬核架构班：狠卷 3 高架构，卷透底层技术，走向技术自由！


### 使用滑动窗口，实现无锁化读写

```
弹幕数据的读写，如果使用阻塞队列，那么需要加锁
如果加锁，在超高并发场景，会性能非常低
如何实现无锁化读写呢
基于滑动窗口技术，实现无锁化读写，保证在 超高并发场景并发读写的性能
```
```
为了数据拉取方便，我们将数据按照时间进行分片，将时间作为数据切割的单位，按照时间存储、拉
取、缓存数据（RingBuffer），简化了数据处理流程。
与传统的Ring Buffer不一样的是，我们只保留了尾指针，
它随着时间向前移动，每一秒向前移动一格，把时间戳和对应弹幕列表并写到一个区块当中，因此最多
保留 60 秒的数据。
同时，如果此时来了一个读请求，那么缓冲环会根据客户端传入的时间戳计算出指针的索引位置，并从
尾指针的副本区域往回遍历直至跟索引重叠，收集到一定数量的弹幕列表返回，
这种机制保证了缓冲区的区块是整体有序的，因此在读取的时候只需要简单地遍历一遍即可，加上使用
的是数组作为存储结构，带来的读效率是相当高的。
```
```
再来考虑可能出现数据竞争的情况。
先来说写操作，由于在这个场景下，写操作是单线程的，因此大可不必关心并发写带来的数据一致性问
题。
```
page: 6/12 of 尼恩 Java 硬核架构班：狠卷 3 高架构，卷透底层技术，走向技术自由！


```
再来说读操作，由图可知写的方向是从尾指针以顺时针方向移动，而读方向是从尾指针以逆时针方向移
动，
而决定读和写的位置是否出现重叠取决于index的位置，
由于我们保证了读操作最多只能读到 30 秒内的数据，因此缓冲环完全可以做到无锁读写
```
```
尼恩提示： 滑动窗口的原理和源码非常重要
具体，可以去学习第 26 章视频 《100WQps三级缓存组件实操》里边有滑动窗口的起底式、穿透
式介绍
```
### 通过短轮训实现弹幕促达

```
Long Polling和Websockets都不适用弱环境，
所以我们最终采取了 短轮训 的方案来实现弹幕促达
```
##### 弹幕卡顿、丢失分析

```
在开发弹幕系统的的时候，最常见的问题是该怎么选择促达机制，
推送 vs 拉取 ？
长轮询 vs 短 轮询
```
##### 基于 AJAX 的长轮询方案 （Long Polling via AJAX）

```
客户端打开一个到服务器端的 A JAX 请求，然后等待响应，
服务器端需要一些特定的功能来允许请求被挂起，只要一有事件发生，服务器端就会在挂起的请求中送
回响应。
如果打开Http的Keepalived开关，还可以节约握手的时间。
```
page: 7/12 of 尼恩 Java 硬核架构班：狠卷 3 高架构，卷透底层技术，走向技术自由！


```
优点：
减少轮询次数，低延迟，浏览器兼容性较好。
缺点：
服务器需要保持大量连接。
```
##### 基于 WebSockets 的双向通讯方案

```
长轮询虽然省去了大量无效请求，减少了服务器压力和一定的网络带宽的占用，但是还是需要保持大量
的连接。
那么人们就在考虑了，有没有这样一个完美的方案，即能双向通信，又可以节约请求的 header 网络开
销，并且有更强的扩展性，最好还可以支持二进制帧，压缩等特性呢？
于是人们就发明了这样一个目前看似“完美”的解决方案 —— WebSocket。
它的最大特点就是：
服务器可以主动向客户端推送信息，客户端也可以主动向服务器发送信息，是真正的双向平等对话。
```
page: 8/12 of 尼恩 Java 硬核架构班：狠卷 3 高架构，卷透底层技术，走向技术自由！


```
优点 1 ：较少的控制开销，
较少的控制开销，在连接创建后，服务器和客户端之间交换数据时，用于协议控制的数据包头部相对较
小。
在不包含扩展的情况下，对于服务器到客户端的内容，此头部大小只有 2 至 10 字节（和数据包长度有
关）；
对于客户端到服务器的内容，此头部还需要加上额外的 4 字节的掩码。
相对于 HTTP 请求每次都要携带完整的头部，此项开销显著减少了。
优点 2 ：更强的实时性，
更强的实时性，由于协议是全双工的，所以服务器可以随时主动给客户端下发数据。
相对于HTTP请求需要等待客户端发起请求服务端才能响应，延迟明显更少；
即使是和Comet等类似的长轮询比较，其也能在短时间内更多次地传递数据。
优点 3 ：长连接，保持连接状态 。
```
##### Long Polling vs Websockets

```
无论是以上哪种方式，都使用到TCP长连接，那么TCP的长连接是如何发现连接已经断开了呢？
TCP Keepalived会进行连接状态探测，探测间隔主要由三个配置控制。
keepalive_probes：探测次数（默认： 7 次）
keepalive_time 探测的超时（默认： 2 小时）
keepalive_intvl 探测间隔(默认：75s)
但是由于在东南亚的弱网情况下，TCP长连接会经常性的断开:
Long Polling 能发现连接异常的最短间隔为：min(keepalive_intvl, polling_interval)
Websockets能发现连接异常的最短间隔为：Websockets: min(keepalive_intvl,
client_sending_interval)
```
page: 9/12 of 尼恩 Java 硬核架构班：狠卷 3 高架构，卷透底层技术，走向技术自由！


```
如果下次发送数据包的时候可能连接已经断开了，所以使用TCP长连接对于两者均意义不大。
并且弱网情况下, Websockets其实已经不能作为一个候选项了
即使Websockets服务端已经发现连接断开，仍然没有办法推送数据，只能被动等待客户端重新建
立好连接才能推送，在此之前数据将可能会被采取丢弃的措施处理掉。
在每次断开后均需要再次发送应用层的协议进行连接建立。
根据了解, 腾讯云的弹幕系统:
在 300 人以下使用的是推送模式，
300 人以上则是采用的轮训模式。
但是考虑到资源消耗情况，他们可能使用的是Websocket来实现的弹幕系统，
也就是 300 人以上轮训模式， 腾讯云也是基于Websocket 来实现的，不太可能基于 A JAX来实现，
正式因为基于Websocket ，在弱网环境下，所以才会出现弹幕卡顿、丢失的情况。
综上所述，Long Polling和Websockets都不适用我们面临的环境，
所以我们最终采取了 短轮训 的方案来实现弹幕促达
```
### 传输优化、节约带宽

```
为了降低带宽压力，我们主要采用了以下方案：
1. 启用Http压缩
通过查阅资料，http gzip压缩比率可以达到40%以上（gzip比deflate要高出4%~5%）。
```
page: 10/12 of 尼恩 Java 硬核架构班：狠卷 3 高架构，卷透底层技术，走向技术自由！


```
2. Response结构简化
```
```
3. 内容排列顺序优化
根据gzip的压缩的压缩原理可以知道，重复度越高，压缩比越高，
因此 : 可以将字符串和数字内容放在一起摆放
4. 频率控制
带宽控制：通过添加请求间隔参数（下次请求时间），保证客户端的请求频率服务端可
控。
以应对突发的流量增长问题，提供有损的服务。
稀疏控制：在弹幕稀疏和空洞的时间段，通过控制下次请求时间，避免客户端的无效请
求。
```
### 总结

```
最终该服务在双十二活动中，在Redis出现短暂故障的背景下，
高效且稳定的支撑了单房间70w用户在线，成功完成了既定的目标
```
### 参考文献：

https://halfrost.com/websocket/
page: 11/12 of 尼恩 Java 硬核架构班：狠卷 3 高架构，卷透底层技术，走向技术自由！


```
https://shopee-sz.github.io/2019/02/27/livechat/
https://www.cyningsun.com/03-31-2019/live-streaming-danmaku.html
```
page: 12/12 of 尼恩 Java 硬核架构班：狠卷 3 高架构，卷透底层技术，走向技术自由！


```
疯狂创客圈^
```
# 硬核推荐：尼恩 Java 硬核架构班

## 又名疯狂创客圈社群 VIP

## 详情：https://www.cnblogs.com/crazymakercircle/p/9904544.html


疯狂创客圈^


```
疯狂创客圈^
```
#### 架构班（社群 VIP）的起源：^

最初的视频，主要是给读者加餐。很多的读者，需要一些高质量的实操、理论视频，所以，我就围绕书，和
底层，做了几个实操、理论视频，然后效果还不错，后面就做成迭代模式了。

#### 架构班（社群 VIP）的功能：^

提供高质量实操项目整刀真枪的架构指导、快速提升大家的:
 开发水平
 设计水平
 架构水平
弥补业务中 CRUD 开发短板，帮助大家尽早脱离具备 3 高能力，掌握：
 高性能
 高并发
 高可用
作为一个高质量的架构师成长、人脉社群，把所有的卷王聚焦起来，一起卷：
 卷高并发实操
 卷底层原理
 卷架构理论、架构哲学
 最终成为顶级架构师，实现人生理想，走向人生巅峰

#### 架构班（社群 VIP）的目的：^

 高质量的实操，大大提升简历的含金量，吸引力，增强面试的召唤率
 为大家提供九阳真经、葵花宝典，快速提升水平
 进大厂、拿高薪
 一路陪伴，提供助学视频和指导，辅导大家成为架构师
 自学为主，和其他卷王一起，卷高并发实操，卷底层原理、卷大厂面试题，争取狠卷 3 月成高手，狠卷
3 年成为顶级架构师


```
疯狂创客圈^
```
#### N 个超高并发实操项目：简历压轴、个顶个精彩


```
疯狂创客圈^
```
###### 【样章】第 17 章：横扫全网 Rocketmq 视频第 2 部曲: 工业级 rocketmq 高可用（HA）

###### 底层原理和实操

工业级 rocketmq 高可用底层原理，包含：消息消费、同步消息、异步消息、单向消息等不同消息的底层原理
和源码实现；消息队列非常底层的主从复制、高可用、同步刷盘、异步刷盘等底层原理。
工业级 rocketmq 高可用底层原理和搭建实操，包含：高可用集群的搭建。
解决以下难题：
1 、技术难题：RocketMQ 如何最大限度的保证消息不丢失的呢？RocketMQ 消息如何做到高可靠投递？
2 、技术难题：基于消息的分布式事务，核心原理不理解
3 、选型难题： kafka or rocketmq ，该娶谁？
下图链接：https://www.processon.com/view/6178e8ae0e3e7416bde9da


```
疯狂创客圈^
```
#### 成功案例：^2 年翻^3 倍，^35 岁卷王成功转型为架构师^

详情：http://topcoder.cloud/forum.php?mod=forumdisplay&fid=43&page=


疯狂创客圈^


疯狂创客圈^


疯狂创客圈^


```
疯狂创客圈^
```
## 简历优化后的成功涨薪案例（VIP 含免费简历优化）


疯狂创客圈^


疯狂创客圈^


疯狂创客圈^


疯狂创客圈^


疯狂创客圈^


```
疯狂创客圈^
```
# 修改简历找尼恩（资深简历优化专家）

 如果面试表达不好，尼恩会提供简历优化指导

 如果项目没有亮点，尼恩会提供项目亮点指导

 如果面试表达不好，尼恩会提供面试表达指导

作为 40 岁老架构师，尼恩长期承担技术面试官的角色：

 从业以来，“阅历”无数，对简历有着点石成金、改头换面、脱胎换骨的指导能力。

 尼恩指导过刚刚就业的小白，也指导过 P 8 级的老专家，都指导他们上岸。

如何联系尼恩。尼恩微信，请参考下面的地址：

语雀：https://www.yuque.com/crazymakercircle/gkkw8s/khigna
码云：https://gitee.com/crazymaker/SimpleCrayIM/blob/master/疯狂创客圈总目录.md


