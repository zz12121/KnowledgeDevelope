### 峰值 21 WQps、亿级 DAU，小游戏《羊了个羊》是怎么架

### 构的？

```
小游戏《羊了个羊》 短短的 7 天内，DAU突破了 1 亿、吞吐量峰值21WQps。
《羊了个羊》运营后台数据显示，在短短的 7 天内，这款小游戏的DAU就突破了 1 亿。
要知道，除了王者荣耀、原神等屈指可数的现象级手游之外， 1 亿DAU是这个行业的天花板，
可是，它却被一个看上去设计粗糙的小程序游戏轻松实现了。
然而，其最初技术架构仅支撑 5000QPS并发 ， 7 天内突破了 1 亿、吞吐量峰值21WQps
```
```
如何通过架构优化，让一款小程序游戏可以在短时间内实现对上亿DAU的支持？
技术架构、运维体系、以及安全防范等技术体系都存在巨大的挑战。
那么：峰值21WQps、亿级DAU，超高吞吐小游戏，是怎么架构的？
```
page: 1/6 of 尼恩 Java 硬核架构班：狠卷 3 高架构，卷透底层技术，走向技术自由！


### 1 低吞吐、低可用的最初技术架构

```
《羊了个羊》最开始的技术架构，
因为技术以及时间等因素，在设计上有些简单，
如下图 1 所示，
```
page: 2/6 of 尼恩 Java 硬核架构班：狠卷 3 高架构，卷透底层技术，走向技术自由！


```
玩家流量通过一个接入层 LB进入，
传输给服务层几个 POD 进行游戏逻辑处理，
再将数据进行存储，
其中，热数据存储在Redis中, 持久化数据存在MongoDB。
最初的服务层几个 POD ，都是单点服务
单点服务的性能瓶颈，再加上代码未进行充分优化，造成当时的系统最高只能承受 5000 的QPS ，
但实际流量增长很快， 并且持续升高并到达性能瓶颈，游戏服务开始瘫痪，全部玩家无法再进行游戏。
```
### 2 技术架构全面升级

```
大部分项目，都存在低吞吐、低可用的最初技术架构
但是，如果吞吐量一上来，就面临着优化
so，
面对服务中断， 《羊了个羊》团队在详细分析原来架构的不足之后，
《羊了个羊》 做了 技术架构全面升级
具体如下图：
```
接入层的架构优化：
启用 CDN 做游戏动静态资源分离，让玩家使用的游戏资源实现就近下载，减轻网络端压力；
设计多 LB 入口实现入口高可用和限流，避免系统被超额流量过载；
page: 3/6 of 尼恩 Java 硬核架构班：狠卷 3 高架构，卷透底层技术，走向技术自由！


```
服务层的架构优化：
优化服务层的自动扩容，应对巨量的 突发流量
具体措施上，首先通过引入腾讯云TKE Serverless 的弹性机制，实现游戏服自动纵向和横向扩展，
实现服务解藕，增加容错和熔断机制；
Cache层的架构优化：
Redis缓存热数据，分担数据库查询压力等。
存储层的架构优化：
把MongoDB转换为读写分离模式，配合代码逻辑优化实现性能提升，
引入分库实现业务分层与隔离，
```
```
优化之后，《羊了个羊》最新技术架构
```
```
经过上述一系列技术升级， 新架构经受住了一波又一波的流量峰值考验，
在高峰期DAU过亿后，游戏技术系统依旧表现稳定，
这对于一个发布才几个月的小游戏来说，在国内也很难再找到这样的例子。
```
page: 4/6 of 尼恩 Java 硬核架构班：狠卷 3 高架构，卷透底层技术，走向技术自由！


### 3 运维体系的升级

```
通过技术架构的迭代以及不断激增的用户，《羊了个羊》技术团队也认识到，因为爆火太快，更需要快
速补齐运维能力，才能更好的持续调整和提升游戏体验。
在运维体系这块，包括 业务日志、性能监测等。
为快速补齐运维能力，通过 业务日志诊断 程序性能，配合业务调优以减少服务器压力；
```
```
《羊了个羊》选择了开箱即用的日志服务 云服务度 CLS，
当然，有条件的团队，使用自建的 elk平台，或者基于clickhouse的高并发分布式日志监测平台，也是
可以的。
CLS 对游戏接口稳定性、异常调用趋势的监控可帮助他们快速观测产品质量 ，并第一时间获取到异常
panic统计分析和告警 ；
在游戏运营方面，玩家登录链路耗时/对局时间等数据亦可通过 CLS 分析、校验及处理，进而调整和提
升游戏体验；同时还能满足游戏用户行为及审计对账等需求。
```
```
CLS的云原生特性,辅助进行稳定性和程序性能调优。另外，CLS用作简单运维工具查日志、做接口调用
告警
借助CLS的SQL分析、仪表盘、监控告警能力，
可以分析出程序可优化点, 解决游戏开发商在初期和爆发期对游戏稳定性和运营数据分析的难题。
除了运维数据外，
CLS还提供了数据观测功能
在游戏调整玩法、分析活动数据时，运营人员可借助CLS快速观测数据变化，并作出应对策略。
另外，还将游戏的通关数据、用户行为分析、审计对账等运营数据在CLS中存储分析。
```
### 4 安全防范领域的升级

```
哪里有流量，哪里就有黑产。
许多恶意BOT流量大量涌入到游戏中，导致游戏服务器 QPS、带宽快速升高，影响服务可用性等情况
由于设计之初没有充分考虑安全问题，因此引来大量不法分子通过恶意BOT抢刷游戏排行，
几乎每分每秒，都有恶意流量访问游戏接口，
并且这一部分恶意群体通过互联网、QQ群和微信群中传播恶意刷排行的脚本，
极大的破坏了游戏公平性，让本该属于游戏对抗的乐趣被恶意BOT抹杀。
```
而且更重要的是随着羊了个羊热度的不但攀升，许多恶意 BOT 流量的大量涌入，导致游戏服务器 QPS、
带宽快速升高，一度影响服务可用性。
**<养了个羊>接入腾讯云 WAF 进行防护，
一开始接入 WAF 的时候，相关 QPS 峰值已达 21 W，**
page: 5/6 of 尼恩 Java 硬核架构班：狠卷 3 高架构，卷透底层技术，走向技术自由！


```
接入WAF之前CPU一直处于临界值水位 、网络链接打满的导致服务不可用的情况。
```
```
通过选择负载均衡型WAF, 即可在不改动网络架构的情况下 3 秒完成业务接入WAF，实现在用户无感的
情况下对恶意流量进行清洗及防护。
为了有效打击攻击者的恶意流量，
WAF 中 BOT 行为管理也提供了全链路、全生命周期的的恶意行为流量体系，实现快速高效的恶意流量
治理。
最后在安全防范领域，通过安全方案抵抗异常流量攻击。
```
### 5 互联网应用设计的“三高”原则

```
通过《羊了个羊》团队在小游戏架构扩容、系统运维以及安全防范领域的实战经验，可以给大家一些参
考。
面对突发流量，互联网应用在设计的过程中需要考虑以下能力：
第一是 高并发 ，能够承载瞬时爆发流量，保证响应时长在可接受的范围；
其次是 高可用 ，系统持续提供服务，小概率发生宕机时，过载保护将故障控制在可承受范围内，不影响
核心业务；
最后是 高扩展 ，服务系统应该具备水平和垂直扩展能力，在成本和可用性中实现最佳平衡点。
```
page: 6/6 of 尼恩 Java 硬核架构班：狠卷 3 高架构，卷透底层技术，走向技术自由！


# 硬核推荐：尼恩 Java 硬核架构班

## 又名疯狂创客圈社群 VIP

## 详情：https://www.cnblogs.com/crazymakercircle/p/9904544.html



#### 架构班（社群 VIP）的起源：^

最初的视频，主要是给读者加餐。很多的读者，需要一些高质量的实操、理论视频，所以，我就围绕书，和
底层，做了几个实操、理论视频，然后效果还不错，后面就做成迭代模式了。

#### 架构班（社群 VIP）的功能：^

提供高质量实操项目整刀真枪的架构指导、快速提升大家的:
 开发水平
 设计水平
 架构水平
弥补业务中 CRUD 开发短板，帮助大家尽早脱离具备 3 高能力，掌握：
 高性能
 高并发
 高可用
作为一个高质量的架构师成长、人脉社群，把所有的卷王聚焦起来，一起卷：
 卷高并发实操
 卷底层原理
 卷架构理论、架构哲学
 最终成为顶级架构师，实现人生理想，走向人生巅峰

#### 架构班（社群 VIP）的目的：^

 高质量的实操，大大提升简历的含金量，吸引力，增强面试的召唤率
 为大家提供九阳真经、葵花宝典，快速提升水平
 进大厂、拿高薪
 一路陪伴，提供助学视频和指导，辅导大家成为架构师
 自学为主，和其他卷王一起，卷高并发实操，卷底层原理、卷大厂面试题，争取狠卷 3 月成高手，狠卷
3 年成为顶级架构师


#### N 个超高并发实操项目：简历压轴、个顶个精彩


##### 【样章】第 17 章：横扫全网 Rocketmq 视频第 2 部曲: 工业级 rocketmq 高可用（HA）

##### 底层原理和实操

工业级 rocketmq 高可用底层原理，包含：消息消费、同步消息、异步消息、单向消息等不同消息的底层原理
和源码实现；消息队列非常底层的主从复制、高可用、同步刷盘、异步刷盘等底层原理。
工业级 rocketmq 高可用底层原理和搭建实操，包含：高可用集群的搭建。
解决以下难题：
1 、技术难题：RocketMQ 如何最大限度的保证消息不丢失的呢？RocketMQ 消息如何做到高可靠投递？
2 、技术难题：基于消息的分布式事务，核心原理不理解
3 、选型难题： kafka or rocketmq ，该娶谁？
下图链接：https://www.processon.com/view/6178e8ae0e3e7416bde9da


#### 成功案例：^2 年翻^3 倍，^35 岁卷王成功转型为架构师^

###### 详情：http://topcoder.cloud/forum.php?mod=forumdisplay&fid=43&page=





## 简历优化后的成功涨薪案例（VIP 含免费简历优化）







# 修改简历找尼恩（资深简历优化专家）

######  如果面试表达不好，尼恩会提供简历优化指导

######  如果项目没有亮点，尼恩会提供项目亮点指导

######  如果面试表达不好，尼恩会提供面试表达指导

###### 作为 40 岁老架构师，尼恩长期承担技术面试官的角色：

######  从业以来，“阅历”无数，对简历有着点石成金、改头换面、脱胎换骨的指导能力。

######  尼恩指导过刚刚就业的小白，也指导过 P 8 级的老专家，都指导他们上岸。

###### 如何联系尼恩。尼恩微信，请参考下面的地址：

###### 语雀：https://www.yuque.com/crazymakercircle/gkkw8s/khigna

###### 码云：https://gitee.com/crazymaker/SimpleCrayIM/blob/master/疯狂创客圈总目录.md


